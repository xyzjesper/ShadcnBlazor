@inherits ShadcnBase

<div data-state="@(IsOpen ? "open" : "closed")"
     data-slot="collapsible"
     class="@Classes">
    <CascadingValue TValue="Collapsible" IsFixed="true" Value="this">
        @ChildContent
    </CascadingValue>
</div>

@code
{
    [Parameter] public RenderFragment ChildContent { get; set; }
    [Parameter] public EventCallback<bool> OnOpenChange { get; set; }
    [Parameter] public bool DefaultOpen { get; set; }
    [Parameter] public bool Disabled { get; set; }

    public bool IsOpen { get; private set; }
    
    internal bool ShouldRenderContent { get; private set; }

    private string? Classes;
    
    protected override void OnInitialized()
    {
        IsOpen = DefaultOpen;
    }

    protected override void OnParametersSet()
    {
        Classes = Cn(ClassName);
    }

    public async Task ToggleAsync()
    {
        if (IsOpen)
        {
            IsOpen = false;

            await InvokeAsync(StateHasChanged).ContinueWith(async _ =>
            {
                await Task.Delay(50);

                ShouldRenderContent = false;
                await InvokeAsync(StateHasChanged);
            });
        }
        else
        {
            IsOpen = true;
            ShouldRenderContent = true;

            await InvokeAsync(StateHasChanged);
        }

        await OnOpenChange.InvokeAsync(IsOpen);
    }
}
