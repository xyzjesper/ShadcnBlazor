@using Microsoft.AspNetCore.Components.Sections
@using ShadcnBlazor.Interop

@implements IMenuParent

<CascadingValue TValue="Menu" Name="Menu" IsFixed="true" Value="this">
    <CascadingValue TValue="IMenuParent" Name="MenuParent" IsFixed="true" Value="this">
        @ChildContent
    </CascadingValue>
</CascadingValue>

<SectionOutlet SectionName="@ContentSectionId"/>
<SectionOutlet SectionName="@SubContentSectionId"/>

@code
{
    [Parameter] public RenderFragment ChildContent { get; set; }

    public bool IsOpen { get; private set; }
    public bool ShouldRenderContent { get; private set; }

    public IMenuItem? FocusedItem { get; private set; }

    public string ContentSectionId => $"menu-content-{GetHashCode()}";
    public string SubContentSectionId => $"menu-sub-content-{GetHashCode()}";

    private MenuContent ContentRef;

    internal void SetContentRef(MenuContent content) => ContentRef = content;

    public async Task OpenAsync()
    {
        ShouldRenderContent = true;
        IsOpen = true;

        await InvokeAsync(StateHasChanged).ContinueWith(async _ => { await ContentRef.OnOpenedAsync(); });
    }

    public async Task CloseAsync()
    {
        IsOpen = false;

        await InvokeAsync(StateHasChanged).ContinueWith(async _ =>
        {
            await Task.Delay(50); // Wait for animation to play

            ShouldRenderContent = false; // Remove content from dom
            await InvokeAsync(StateHasChanged);
        });
    }

    public async Task ChangeFocusAsync(IMenuItem item)
    {
        // Notify old focused component, that it is now unfocused again
        if (FocusedItem != null && FocusedItem != item)
            await FocusedItem.OnUnfocusedAsync();

        FocusedItem = item;
        await InvokeAsync(StateHasChanged);
    }

    // When an item has been selected (which is not a sub menu), this function gets called
    public async Task CloseMenuAsync()
        => await CloseAsync();
}
