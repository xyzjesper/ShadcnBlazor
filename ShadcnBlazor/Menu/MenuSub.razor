@implements IMenuParent
@implements IMenuItem

<CascadingValue TValue="MenuSub" Name="MenuSub" IsFixed="true" Value="this">
    <CascadingValue TValue="IMenuParent" Name="MenuParent" IsFixed="true" Value="this">
        @ChildContent
    </CascadingValue>
</CascadingValue>

@code
{
    [CascadingParameter(Name = "Menu")] public Menu Menu { get; set; }
    [Parameter] public RenderFragment ChildContent { get; set; }
    
    public IMenuItem? FocusedItem { get; private set; }
    
    public bool IsOpen { get; private set; }
    public bool ShouldRenderContent { get; private set; }

    private MenuSubContent ContentRef;

    public async Task OpenAsync(ElementReference trigger)
    {
        IsOpen = true;
        ShouldRenderContent = true;

        await Menu.ChangeFocusAsync(this).ContinueWith(async _ =>
        {
            await ContentRef.OnOpenedAsync(trigger);
        });
    }

    public async Task CloseAsync()
    {
        IsOpen = false;

        await InvokeAsync(StateHasChanged).ContinueWith(async _ =>
        {
            await Task.Delay(50); // Wait for animation to play

            ShouldRenderContent = false; // Remove content from dom
            await InvokeAsync(StateHasChanged);
        });
    }
    
    public async Task ChangeFocusAsync(IMenuItem item)
    {
        if (FocusedItem != null && FocusedItem != item)
            await FocusedItem.OnUnfocusedAsync();
        
        FocusedItem = item;
        await InvokeAsync(StateHasChanged);
    }

    internal void SetContentRef(MenuSubContent content) => ContentRef = content;
    
    public Task CloseMenuAsync()
        => Menu.CloseMenuAsync();

    public async Task OnUnfocusedAsync()
        => await CloseAsync();
}
