@using ShadcnBlazor.Interop

@inherits ShadcnBase

@inject PositionService PositionService

<div data-state="@(Item.IsOpen ? "open" : "closed")"
     role="region"
     data-orientation="vertical"
     data-slot="accordion-content"
     class="data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down overflow-hidden text-sm"
     style="--radix-accordion-content-height: var(--radix-collapsible-content-height); --radix-accordion-content-width: var(--radix-collapsible-content-width); --radix-collapsible-content-height: @(BoundingBox.Height)px; --radix-collapsible-content-width: @(BoundingBox.Width)px;"
     @attributes="Props">

    @if (Item.ShouldRenderContent)
    {
        <div @ref="ContentContainer" class="@Classes">
            @ChildContent
        </div>
    }

</div>

@code
{
    [CascadingParameter(Name = "AccordionItem")]
    public AccordionItem Item { get; set; }

    [Parameter] public RenderFragment ChildContent { get; set; }

    private ElementReference ContentContainer;
    private DomRect BoundingBox = new();
    private string? Classes;

    protected override void OnInitialized()
    {
        Item.SetContentRef(this);
    }

    protected override void OnParametersSet()
    {
        Classes = Cn("pt-0 pb-4", ClassName);
    }

    public async Task OnOpened()
    {
        BoundingBox = await PositionService.GetBoundingBoxAsync(ContentContainer);
        await InvokeAsync(StateHasChanged);
    }
}
